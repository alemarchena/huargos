<style>
th{
    font-family: 'Barlow', sans-serif;
    color: #534c07;
}

/* Tooltip container */
.tooltipbutton {
  position: relative;
  display: inline-block;
}

/* Tooltip text */
.tooltiptext {
  visibility: hidden;
  width: 160px;
  height: 60px;
  line-height: 60px;
  background-color: rgb(49, 49, 49);
  color: #fff;
  text-align: center;
  padding: 0px 0;
  border-radius: 6px;
 
  /* Position the tooltip text - see examples below! */
  position: absolute;
  z-index: 1;
  top: -5px;
  right: 105%;
}

/* Show the tooltip text when you mouse over the tooltip container */
.tooltipbutton:hover .tooltiptext {
    visibility: visible;
}

#muestrafoto #muestracertificado{
    width: 50px;
    height: auto;
}

#espera{visibility: hidden;}

</style>

<div id="divarriba" class="row pb-3">
    <div class="col-sm-2" style="text-align: center;">
        <img class="logo" src="./img/logoempresa.png" alt="" width="auto" height="100px" >   
    </div>
    <div class="col-sm-8">
        <div class="d-flex justify-content-center">
            <h4>Alumnos</h4>
        </div>
    </div>
    <div class="col-sm-1" style="text-align: right;">
        <div class="tooltipbutton">
            <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#formulariomodal" data-whatever="@getbootstrap" onclick="Agregar()"><span class="material-icons md-light md-48">add_circle</span> </a>
            <span class="tooltiptext">Agregar alumno</span>
        </div>
    </div>
    <div class="col-sm-1" style="text-align: center;">
        <div class="tooltipbutton">
            <button id="volver" type="button" class="btn btnmenu" onclick="Volver()"><span class="material-icons md-light md-48">undo</span> </a>
            <span class="tooltiptext">Regresar al menú</span>
            </button>
        </div>
    </div>
</div>
<br>
<div id="divformulario" class="d-flex justify-content-center container" >

      <div class="row  ">
        <div class="col-sm-12 col-md-1" style="text-align: center;">
            <button id="refrescar" onclick="Listar()" class="btn btn-success"><span class="material-symbols-outlined">refresh</span></button>
        </div>
      </div>
</div>

<div id="espera" class="d-flex justify-content-center">
    <div class="spinner-border text-warning" role="status">
        <span class="sr-only">Loading...</span>
    </div>
</div>
<div class="row">
    <div class="col-sm-12">
        <table id="tabla" class="display table table-striped" style="width: 100%!important;">        
            <thead><tr>
                <th>id</th>
                <th>Usuario</th>
                <th>Apellido</th>
                <th>Nombre</th>
                <th>whatsapp</th>
                <th>email</th>
                <th>días vto</th>
                <th>Editar</th>
                <th>Eliminar</th>
            </tr></thead>
            <tbody><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tbody>
        </table>
    </div>
    
</div>
 <!-- ------------------------------------------------- Modal --------------------------------------------------- -->
 
<div class="modal fade" id="formulariomodal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">Alumnos</h5>
        <button id="cerrarboton" type="button" class="close btn btnmenu" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form method="post" enctype="multipart/form-data" name="fileinfo">
            <div class="row">
                <div class="col-sm-10 col-md-2" >
                    <div class="form-group">  
                        <label for="activador" class="col-form-label">Cambia el estado:</label>                      
                        <button id="activador" onclick="ActivaDesactiva()" type="button" class="form-control btn btn-primary btn-sm">Activador</button>
                    </div>
                </div>
                <div class="col-sm-2">
                    <div class="form-group">
                        <label for="idalumno" class="col-form-label">Id alumno:</label>
                        <input type="text" class="form-control" id="idalumno" readonly>
                    </div>
                </div>
                
                <div class="col-sm-10 col-md-4">
                    <div class="form-group">
                        <label for="nombre" class="col-form-label">Nombre del alumno:</label>
                        <input type="text" class="form-control" id="nombre">
                    </div>
                </div>
                <div class="col-sm-10 col-md-4">
                    <div class="form-group">
                        <label for="apellido" class="col-form-label">Apellido del alumno:</label>
                        <input type="text" class="form-control" id="apellido">
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <div class="row">
                    <div class="col-sm-10 col-md-2">
                        <label for="estado" class="col-form-label">Estado:</label>
                        <input type="text" readonly class="form-control" id="estado">
                    </div>
                    
                    <div class="col-sm-10 col-md-4">
                        <label for="dni" class="col-form-label">DNI:</label>
                        <input type="text" class="form-control" id="dni" placeholder="XXxxxXXX (no incluir puntos)">
                    </div>
                    <div class="col-sm-10 col-md-4">
                        <label for="fechanacimiento" class="col-form-label">Fecha nacimiento</label>
                        <input type="date" id="fechanacimiento" name="fechanacimiento">
                    </div>
                    <div class="col-sm-10 col-md-2 ">
                        <label for="diasvencimiento" class="col-form-label">Días vencimiento</label>
                        <input type="number" id="diasvencimiento" name="diasvencimiento" value="30" min="0" max="365">
                    </div>
                </div>
            </div>
            <div class="form-group">
                <div class="row">
                    <div class="col-sm-10 col-md-4">
                        <div class="form-group">
                            <label for="usuario" class="col-form-label">Usuario:</label>
                            <input type="text" class="form-control" id="usuario" disabled>
                            <a class="btn btn-primary" onclick="UsuarioAleatorio()">Crear clave</a>
                        </div>
                    </div>
                    <div class="col-sm-10 col-md-4 ">
                        <label for="whatsapp" class="col-form-label">Whatsapp</label>
                        <input type="text" class="form-control" id="whatsapp" placeholder="Ej : 549261XXXXXX  sin el +">
                    </div>
                    <div class="col-sm-10 col-md-4">
                        <label for="email" class="col-form-label">email</label>
                        <input type="text" class="form-control" id="email" placeholder="Ej : alexperez@gmail.com">
                    </div>
                </div>
            </div>
            <br>
            <div class="modal-footer">
                <a class="btn btn-warning" onclick="GuardarDatos()" >Guardar</a>
                <button id="botoncerrar" type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
              </div>
            <hr>
            <div id="precargaarchivo"></div>

            <div class="row" >
                <div class="col-sm-12 col-md-6">
                  <div class="row justify-content-center">
                    <label for="fotoalumno">Tu foto</label>
                  </div>
                  <div class="row justify-content-center">
                    <img id="fotoalumno" src="./users/src/imgalumnos/avatarvacio.jpg" alt="" style="height: 200px; width:auto"> 
                    <a href="#" class="btn btn-info" id="botonfoto">Subir tu foto</a> 
                  </div>
                  </div>
                <div class="col-sm-12 col-md-6">
                  <div class="row justify-content-center">
                    <label for="certificado">Tu Certificado de aptitud físico</label>
                  </div>
                  <div class="row justify-content-center">
                    <img id="certificado" src="./users/src/imgalumnos/avatarvacio.jpg" alt="" style="height: 200px; width:auto"> 
                    <a href="#" class="btn btn-success" id="botoncertificado">Subir Certificado aptitud</a> 
                  </div>
                </div>

              </div>
              <hr style="border: 13px solid blue;">
              <input type="file" name="input-file" id="input-file" hidden>
              <div class="d-flex justify-content-center">
                  <div>
                    <div id="preview" class="row justify-content-center"></div>
                  </div>
              </div>

            <!-- <div class="form-group">
                <div class="row">
                    <div class="col-sm-6">
                        <input type="file" id="foto" name="foto" accept="image/*" style="display:none">
                        <a href="#" id="fileSelect">Seleccione una foto del alumno</a>
                        <div id="fileList">
                        <p>No hay archivos seleccionados!</p>
                        </div>
                        <div id="preview"></div>
                    </div>
                    <div class="col-sm-6">
                        <input type="file" id="certificado" name="certificado" accept="image/*" style="display:none">
                        <a href="#" id="fileSelect1">Seleccione una imagen del certificado</a>
                        <div id="fileList1">
                        <p>No hay archivos seleccionados!</p>
                        </div>
                        <div id="preview1"></div>
                    </div>
                </div>
            </div> -->
        </form>
     
      </div>
      
    </div>
  </div>
</div>
<!-- ----------------------------------------------- Fin modal ------------------------------------------------- -->
<script>


arreglo = [];
// var contadorimagenessubidas=0;
// var cantidaddeimagenesasubir=0;

//Campos del formulario
var ldidalumno;
var ldnombre;
var ldapellido;
var ldusuario;
var lddni;
var ldfechanacimiento;
var ldwhatsapp;
var ldemail;
var ldfoto;
var ldcertificado;
var nombrefoto="";
var nombrecertificado="";
var ldestado = "";
var diasvencimiento = "";
var diasvtoestablecidos=30;

function ReconocerCampos(){
    ldidalumno = document.getElementById("idalumno");
    ldnombre = document.getElementById("nombre");
    ldusuario = document.getElementById("usuario");
    ldapellido = document.getElementById("apellido");
    lddni = document.getElementById("dni");
    ldfechanacimiento = document.getElementById("fechanacimiento");
    ldwhatsapp = document.getElementById("whatsapp");
    ldemail = document.getElementById("email");
    ldfoto = document.getElementById("foto");
    ldcertificado = document.getElementById("certificado");
    ldestado = document.getElementById("estado");
    lddiasvencimiento = document.getElementById("diasvencimiento");
}

function ActivaDesactiva(){
    if(ldestado.value == "Activo")
    {
        ldestado.style.backgroundColor = "red";
        ldestado.value = "Inactivo";
    }
    else
    {
        ldestado.style.backgroundColor = "green";
        ldestado.value = "Activo";
    }

}


function UsuarioAleatorio(){
    ldusuario.value = getRandomString(4);
}
function GuardarDatos()
{
    if(ValidarCampos())
    {
        archivodeconsulta = 'abmalumnos.php';

        let idalumno=ldidalumno.value;

        if(ldestado.value == "Activo")
            estado = 1;
        else
            estado = 0;

        if(idalumno==""){
            idalumno=0;
            tipo = "guardar";
        }else{
            tipo = "modificar";
        }
        let datosconsulta = {tipo : tipo,idalumno  : idalumno,nombre : ldnombre.value,apellido:ldapellido.value,dni:lddni.value,fechanacimiento:ldfechanacimiento.value,whatsapp:ldwhatsapp.value,email : ldemail.value,foto:nombrefoto,certificado:nombrecertificado,estado:estado,usuario:ldusuario.value,diasvencimiento:lddiasvencimiento.value}
       
        fetch("./controladores/" + archivodeconsulta +"?n="+ version,{method:'POST',body: JSON.stringify( datosconsulta ),headers:{'Content-Type':'application/json'}})   
        .then(response =>{
            if(response.statusText == 'OK'){}
            return response.json();
        }).then(data => {
            if(data == 1){
                Limpiar();
                mensaje("Excelente", "Se guardó correctamente","success","Ok");

            }
        })
        .catch(function (error){ console.log(error); });
    }

}

function OcultarModal(){
    document.getElementById("botoncerrar").click();
}

document.getElementById("botoncerrar").addEventListener('click',(()=>{
    
    Listar();
}))

document.getElementById("cerrarboton").addEventListener('click',(()=>{
    
    Listar();
}))

function Agregar(){

    Limpiar();
    $('#formulariomodal').on('show.bs.modal', function (event) {
        var button = $(event.relatedTarget) // Button that triggered the modal
        var recipient = button.data('whatever') // Extract info from data-* attributes
        var modal = $(this)
        modal.find('.modal-title').text('Alumnos ')
        // modal.find('.modal-body input').val(recipient)
    })
}

function Volver(){
    $("#bloqueprincipal").load("panelmenu.html?n="+version);
}

function DeseaEliminar(idpasado){
      Swal.fire({
      title: 'Seguro desea eliminar?',
      text: "Esto no podrá revertirse!",
      icon: 'question',
      showCancelButton: true,
      confirmButtonColor: '#3085d6',
      cancelButtonColor: '#d33',
      confirmButtonText: 'Si, Eliminar'
      }).then((result) => {
        if (result.isConfirmed) {
            Eliminar(idpasado);
        }
      })
}

function Eliminar(idpasado){

    // ---------------- Verifica en Pagos --------------------
    archivodeconsulta = 'preborrado.php';
    tipo    = "alumnopagos"; tabla   = "huventas";    idcampo = "idalumno";
    let datosconsulta = {tipo : tipo,tabla  : tabla,idcampo : idcampo,valor:idpasado}
    fetch("./controladores/" + archivodeconsulta +"?n="+ version,{method:'POST',body: JSON.stringify( datosconsulta ),headers:{'Content-Type':'application/json'}})   
    .then(response =>{ if(response.statusText == 'OK'){}return response.json();})
    .then(data=>{
        cantidad = data.length;
        if(cantidad >= 1)
        {
            if(data[0]!="desconocido"){
                mensaje("Importante","La alumno tiene pago registrado, no se puede eliminar!","success","Ok");
            }
        }else{
            // ---------------- Verifica en Reservas --------------------
                archivodeconsulta = 'preborrado.php';
                tipo    = "alumnoreservas"; tabla   = "hureservas";    idcampo = "idalumno";
                let datosconsulta = {tipo : tipo,tabla  : tabla,idcampo : idcampo,valor:idpasado}
                fetch("./controladores/" + archivodeconsulta +"?n="+ version,{method:'POST',body: JSON.stringify( datosconsulta ),headers:{'Content-Type':'application/json'}})   
                .then(response =>{ if(response.statusText == 'OK'){}return response.json();})
                .then(data=>{
                    cantidad = data.length;
                    if(cantidad >= 1)
                    {
                        if(data[0]!="desconocido"){
                            mensaje("Importante","El alumno tiene reserva registrada, no se puede eliminar!","success","Ok");
                        }
                    }else{
                        // -------------------------------------------------------

                            nomfoto='';
                            nomcerti='';
                            
                            for(a=0;a<arreglo.length;a++)
                            {
                                if(arreglo[a].idalumno == idpasado)
                                {
                                    nomfoto = arreglo[a].foto;
                                    nomcerti = arreglo[a].certificado;
                                }
                            }

                            archivodeconsulta = 'abmalumnos.php';
                            tipo = "eliminar";

                            datosconsulta = {tipo : tipo,idalumno  : idpasado,nombre : "",apellido:"",dni:"",fechanacimiento:"",whatsapp:"",foto:"",certificado:"",estado:"",usuario:'',diasvencimiento:'',email:''}

                            fetch("./controladores/" + archivodeconsulta +"?n="+ version,{method:'POST',body: JSON.stringify( datosconsulta ),headers:{'Content-Type':'application/json'}})   
                            .then(response =>{if(response.statusText == 'OK'){}return response.json();})
                            .then(data=>{
                                if(data == 1)
                                {
                                    // EliminarUsuarioClave(idpasado);
                                    if(nomfoto!='')
                                        EliminarImagen(nomfoto);

                                    if(nomcerti!='')
                                        EliminarImagen(nomcerti);

                                    Listar();
                                    mensaje("Eliminado","El alumno fué eliminado correctamente.","success","Ok");
                                    OcultarModal();
                                }
                            })
                            .catch(function (error){ console.log(error); });
                        // -------------------------------------------------------
                    }
                })
                .catch(function (error){ console.log(error); });
            // -------------------------------------------------
        }
    })
    .catch(function (error){ console.log(error); });

    
}

function ValidarCampos(){
    estado= true;
    if(ldapellido.value.trim()=="" && estado==true){
        mensaje("Faltan datos","Falta ingresar el apellido del alumno","warning","Ok");
        estado=false;
    }
    if(ldnombre.value.trim() == ""){
        mensaje("Faltan datos","Falta ingresar el nombre del alumno","warning","Ok");
        estado=false;
    }

    // if(lddni.value.trim()==""&& estado==true){
    //     mensaje("Faltan datos","Falta ingresar el dni del alumno","info","Ok");
    //     estado=false;
    // }

    if((lddiasvencimiento.value < 0 || lddiasvencimiento.value > 365 ) && estado==true){
        mensaje("Error","Puede ingresar valores entre 0 y 365","warning","Ok");
        estado=false;
    }
   
    
    // if(ldwhatsapp.value.trim()==""&& estado==true){
    //     mensaje("Faltan datos","Falta ingresar el whatsapp del alumno","info","Ok");
    //     estado=false;
    // }else{
    //     nwh=ldwhatsapp.value.trim().replace('+', ' ');
    //     nwh=nwh.trim().replace('-', ' ');
    //     nwh=nwh.trim().replace('(', ' ');
    //     nwh=nwh.trim().replace(')', ' ');
    //     ldwhatsapp.value=nwh;
    // }

    return estado;
}

function Listar()
{
    arreglo = [];
    document.getElementById("espera").style.visibility = "visible";

    archivodeconsulta = 'consultaalumnos.php';
 
    id=ldidalumno.value;

    if(id=="")
        tipoconsulta = "consultatodo";
    else
        tipoconsulta = "consulta";

    if(id=="")id=0;

    let datosconsulta = {tipo : tipoconsulta,idalumno  : id,usuario:''}

    fetch("./controladores/" + archivodeconsulta +"?n="+ version,{method:'POST',body: JSON.stringify( datosconsulta ),headers:{'Content-Type':'application/json'}})   
    .then(response => response.json())
    .then(data => 
    {
        let cantidad =  data.length;
        
        if(data[0] != 'desconocido')
        {
            for(let a = 0 ;a<cantidad;a++) //llenar la lista
            {
                
                toPropuestas = new Object();
                toPropuestas.estado         = data[a].estado;
                toPropuestas.idalumno       = data[a].idalumno;
                toPropuestas.usuario        = data[a].usuario;
                toPropuestas.apellido       = data[a].apellido;
                toPropuestas.nombre         = data[a].nombre;
                toPropuestas.dni            = data[a].dni;
                toPropuestas.fechanacimiento= data[a].fechanacimiento;
                toPropuestas.whatsapp       = data[a].whatsapp;
                toPropuestas.email          = data[a].email;
                toPropuestas.foto           = data[a].foto;
                toPropuestas.certificado    = data[a].certificado;
                toPropuestas.fechaalta      = data[a].fechaalta;
                toPropuestas.diasvencimiento= data[a].diasvencimiento;
                
                arreglo.push(toPropuestas);
            }
        }
        llenartabla();
    })
    .catch(function(error){
        console.log(error); 
        document.getElementById("espera").style.visibility = "hidden";
    
    });
}

function llenartabla()
{
    if ($.fn.dataTable.isDataTable('#tabla')) {
        tabla = $('#tabla').DataTable();
    }

    tabla.clear().draw();
    
    rutaimagen = "./users/src/imgalumnos/";

    for(let a = 0 ;a<arreglo.length;a++)
    {
        // if(arreglo[a].foto == "")
        //     foto = "";
        // else
        //     foto        = "<a href='"+ rutaimagen + arreglo[a].foto +"' target='_blank'><picture><img src='" + rutaimagen + arreglo[a].foto + "' class='img-fluid img-thumbnail zoom'  alt='" + arreglo[a].apellido + "'></picture></a>";

        // if(arreglo[a].certificado == "")
        //     certif = "";
        // else
        //     certif = "<a href='"+ rutaimagen + arreglo[a].certificado +"' target='_blank'><picture><img src='" + rutaimagen + arreglo[a].certificado + "' class='img-fluid img-thumbnail zoom-sm' alt='" + arreglo[a].nombre + "'></picture></a>";

        if(arreglo[a].estado == 1)
            estado = "<p style=background-color:green;color:white>Activo</p>" 
        else
            estado = "<p style=background-color:red;color:white>Inactivo</p>";

            if(arreglo[a].fechanacimiento=='0000-00-00'){
                fechanac = '';
            }else{
                fechanac = conviertefechahispana(arreglo[a].fechanacimiento);
            }
        
        tabla.row.add([
            "<p>" + arreglo[a].idalumno + "</p>" ,  
            arreglo[a].usuario,
            arreglo[a].apellido,
            arreglo[a].nombre,
            arreglo[a].whatsapp,
            arreglo[a].email,
            arreglo[a].diasvencimiento,
            "<button id='Edi" + arreglo[a].idalumno + "'class='btn btn-success btn-sm' type='button' data-toggle='modal' data-target='#formulariomodal' data-whatever='@getbootstrap' onclick='Editar(\"" + arreglo[a].idalumno+"\")'><span class='material-symbols-outlined'>edit</span></button>",
            "<button id='Eli" + arreglo[a].idalumno + "' class='btn btn-success btn-sm btnmenu' type='button' onclick='DeseaEliminar(\"" + arreglo[a].idalumno+"\")'><span class='material-symbols-outlined '>delete</span></button>",
        ]).draw(false);


    }
    document.getElementById("espera").style.visibility = "hidden";

}

function Limpiar(){
   
    ldidalumno.value    = "";
    ldnombre.value      = "";
    ldapellido.value    = "";
    ldusuario.value     = "";
    lddni.value         = "";
    ldfechanacimiento.value        = "";
    ldwhatsapp.value    = "";
    ldemail.value       = "";
    ldestado.value      = "Activo";
    ldestado.style.backgroundColor = "green";
    lddiasvencimiento.value = diasvtoestablecidos;
    nombrefoto          = "";
    nombrecertificado   = "";
    fotoalumno.src = "./users/src/imgalumnos/avatarvacio.jpg";
    certificado.src = "./users/src/imgalumnos/avatarvacio.jpg";
    
    elemento = document.getElementById("preview");
    while (elemento.firstChild) {
        elemento.removeChild(elemento.firstChild);
    }

    
    // contadorimagenessubidas=0;
    // cantidaddeimagenesasubir=0;

    // let entries = formData.entries();
    // for(let pair of entries ) 
    // {
    //     formData.delete( pair[0] );
    // }
}

function Editar(idpasado){
   
    for(let a = 0 ;a<arreglo.length;a++)
    {
        if(arreglo[a].idalumno == idpasado){
            ldidalumno.value    = arreglo[a].idalumno;
            if(arreglo[a].estado == 1)
            {
                ldestado.style.backgroundColor = "green";
                ldestado.value = "Activo";
            }
            else{
                ldestado.style.backgroundColor = "red";
                ldestado.value = "Inactivo";
            }

            ldapellido.value        = arreglo[a].apellido;
            ldnombre.value          = arreglo[a].nombre;
            ldusuario.value         = arreglo[a].usuario;
            lddni.value             = arreglo[a].dni;
            ldfechanacimiento.value = arreglo[a].fechanacimiento;
            ldwhatsapp.value        = arreglo[a].whatsapp;
            ldemail.value           = arreglo[a].email;
            nombrefoto              = arreglo[a].foto;
            nombrecertificado       = arreglo[a].certificado;
            lddiasvencimiento.value = arreglo[a].diasvencimiento;

            if(nombrefoto!='')
                fotoalumno.src = "./users/src/imgalumnos/" + nombrefoto;
            else
                fotoalumno.src = "./users/src/imgalumnos/avatarvacio.jpg";

            if(nombrecertificado!='')
                certificado.src = "./users/src/imgalumnos/" + nombrecertificado;
            else
                certificado.src = "./users/src/imgalumnos/avatarvacio.jpg";

        }
    }
}




async function Configuratabla() 
{
    $('#tabla').DataTable({
        scrollX: true,
        responsive: true,
        'pageLength': 10,
        "columnDefs": [
        { "width": "5%", "targets": 0 },{ "width": "20%", "targets": 1 },{ "width": "5%", "targets": 2 },
        { "width": "5%", "targets":3 },{ "width": "5%", "targets": 4 },{ "width": "5%", "targets": 5 },
        { "width": "5%", "targets": 6 },{ "width": "5%", "targets":7 },{ "width": "20%", "targets": 8 },
        
        {"className": "dt-center", "targets": "_all"}
        ],
        "language": {
        "processing": "Procesando...",
        "search": "Filtrar:",
        "info": "Registro: _START_ de _END_ - Total: _TOTAL_",
        "emptyTable": "No hay registros para ver",
        "infoEmpty": "No hay registros  para ver",
        "paginate": {
            "first": "Primera",
            "previous": "Anterior",
            "next": "Siguiente",
            "last": "Ultima"
        },
        "aria": {
            "sortAscending": "Ordenar columna ascendente",
            "sortDescending": "Ordenar columna descendente"
        },
        order: [[3, 'asc']],
        },
        dom: '<pt><"top"Bftp>',
        // buttons: [{
        //           extend: 'pdfHtml5',
        //           orientation: 'landscape',
        //           pageSize: 'A4',
        //           text: '<button class="btn btn-success botontotal">PDF <i class="fas fa-file-excel"></i></button>'
        //         },
            //     {
            //       extend: 'excel',
                    
            //       text: '<button class="btn btn-success botontotal">Excel <i class="fas fa-file-excel"></i></button>'
            //   },
            //   {
            //   extend: 'print',
            //   text: '<button class="btn btn-success botontotal">Imprimir<i class="fas fa-file-excel"></i></button>'

            //   },
            //   {
            //   extend: 'copy',
            //   text: '<button class="btn btn-success botontotal">COPIAR<i class="fas fa-file-excel"></i></button>'

            //   },
        // ],
    });

}

$(document).ready(function(){
    ReconocerCampos();
    Configuratabla();
});



var input     = document.querySelector("#input-file");

var idalumno  = document.getElementById('idalumno');

var fotoalumno  = document.getElementById('fotoalumno');
var certificado  = document.getElementById('certificado');


var botonfoto = document.getElementById('botonfoto');
var botoncertificado = document.getElementById('botoncertificado');

var quebotontoco;

botonfoto.addEventListener('click',(e)=>{
    e.preventDefault();

    if(ldidalumno.value != '')
    {
        quebotontoco='foto';
        input.click();
    }else{
        mensaje("Atención","Debe guardar un alumno y luego editarlo para subir su foto","warning","Ok");
    }
})

botoncertificado.addEventListener('click',(e)=>{
    e.preventDefault();
    if(ldidalumno.value != '')
    {
        quebotontoco='certificado';
        input.click();
    }else{
        mensaje("Atención","Debe guardar un alumno y luego editarlo para subir su certificado","warning","Ok");
    }

})

input.addEventListener('change',(e) => {
    e.preventDefault();
    const file = input.files;
    showFile(file);
});


function showFile(files){

    if(files === undefined)
    {
        processFile(files);
    }else{
        for(const file of files){
            processFile(file);
        }
    }
}



function processFile(file)
{
    const tipo=file.type;
    const validExtentions = ['image/jpeg','image/jpg','image/png','image/gif'];

    if(validExtentions.includes(tipo) )
    {
        const fileReader = new FileReader();
        const id =  `file-${Math.random().toString(32).substring(7)}`;

        fileReader.addEventListener('load', e => {
            const fileURL = fileReader.result;

                const image =`
                <div id="${id}" class="row container">
                <div class='col-sm-12 col-md-6'>
                    <img src="${fileURL}" alt="${file.name}" width="100px" heigth="auto">
                </div>
                <div class='col-sm-12 col-md-6'>
                    <div class="status"></div>
                    <span>${file.name}</span>
                    <span id="span${id}">Cargando...</span>
                </div>
                `;

            const html = document.querySelector('#preview').innerHTML ;
            document.querySelector('#preview').innerHTML = image + html;
        });

        fileReader.readAsDataURL(file);
        uploadFile(file,id);
    }else{
        alert("No es un archivo válido")
    }
}



uploadFile = async (file,id)=> {
    const formData = new FormData();
    formData.append("file",file);
    try {
        const response = await fetch('./users/src/controladores/subirimagen.php',{method:'POST', body:formData});
        const responseText = await response.text();

        //el div que contiene la imagen toma el nomrbe de la imagen mas un "div" adelante
        const divimagen = document.querySelector(`#${id}`);
        divimagen.id = responseText;
        divimagen.id="div"+ responseText.replace('.','-');

        document.querySelector(`#span${id}`).innerHTML = `<span class="success">Ok</span>`;

        ActualizaImagen(quebotontoco,idalumno.value,responseText)

    } catch (error) {
        document.querySelector(`#span${id}`).innerHTML = `<span class="failure">Error.</span>`;
    }
}

function ActualizaImagen(tipo,idalumno,imagen)    
{
    let datosconsulta = {tipo:tipo,idalumno  : idalumno,imagen : imagen}

    fetch("./users/src/controladores/actualizarimagenalumno.php?n="+ version,{method:'POST',body: JSON.stringify( datosconsulta ),headers:{'Content-Type':'application/json'}})   
    .then(response =>{
        return response.text();
    }).then(data => {
        if(data == 1)
        {
            if(tipo=='foto'){
                // console.log('eliminar foto ' + nombrefoto);
                // console.log('nueva imagen foto ' + imagen)
                fotoalumno.src = "./users/src/imgalumnos/" + imagen;
                setTimeout(() => {
                    eliminaImagen(nombrefoto)
                    nombrefoto = imagen;
                    mensaje("Excelente", "Se actualizó correctamente","success","Ok");

                }, 300);
            }
            if(tipo=='certificado'){
                // console.log('eliminar certificado ' + nombrecertificado);
                // console.log('nueva imagen certificado ' + imagen)
                setTimeout(() => {
                    certificado.src = "./users/src/imgalumnos/" + imagen;
                    eliminaImagen(nombrecertificado);
                    nombrecertificado = imagen;
                    mensaje("Excelente", "Se actualizó correctamente","success","Ok");
                }, 300);
            }
        }
        Limpiar();
    })
    .catch(function (error){ 
        console.log(error); 
        // alert("Error al actualizar la imagen");
    });
}

eliminaImagen = async (imagen)=>
{
    //eliminar el archivo del atleta fisicamente
    let imagenobj = {
    imagen:imagen,
    }
    const eliminarjson = JSON.stringify(imagenobj);
    fetch("./users/src/controladores/eliminarImagen.php",{method:'POST',body:eliminarjson,headers:{'Content-Type':'application/json'}})
    .then(response => response.text())
    .then(data => {
    })
    .catch(function(error) {
        console.log(error)
    });
}




</script>